<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Feedback Anonyme et Bienveillant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAFAFA;
            color: #212121;
        }
        h1, h2, h3, summary {
            font-family: 'Poppins', sans-serif;
        }
        .card {
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            position: relative; /* For positioning star */
        }
        .card textarea {
            flex-grow: 1;
            background-color: transparent;
            border: none !important; 
            outline: none !important;
            box-shadow: none !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            resize: none;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: #212121;
            transition: opacity 0.3s ease-in-out;
        }
        .card .char-counter {
            font-size: 0.75rem;
            text-align: right;
            color: #757575;
            margin-top: 0.25rem;
            transition: opacity 0.3s ease-in-out;
        }
        .card .star-display {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem; /* Adjust star size */
            cursor: pointer;
            opacity: 0;
            pointer-events: none; /* Initially not clickable */
            transition: opacity 0.3s ease-in-out;
        }
        .card.is-star .textarea-wrapper, .card.is-star .char-counter {
            opacity: 0;
            pointer-events: none;
            height: 0; /* Hide effectively */
            overflow: hidden;
        }
        .card.is-star .star-display {
            opacity: 1;
            pointer-events: auto; /* Clickable when star */
        }
        .card:focus-within {
            transform: scale(1.03);
            box-shadow: 0 0 0 3px var(--focus-ring-color, #C8E6C9), 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .strength-card {
            background-color: #E8F5E9;
            --focus-ring-color: #A5D6A7; 
        }
        .improvement-card {
            background-color: #FDECEA;
            --focus-ring-color: #EF9A9A; 
        }
        .strength-star {
            color: #4CAF50; /* Green star */
            animation: strengthScintillate 2s infinite ease-in-out;
        }
        .improvement-star {
            color: #F44336; /* Red star */
            animation: improvementScintillate 2s infinite ease-in-out;
        }
        @keyframes strengthScintillate {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 5px #A5D6A7); }
        }
        @keyframes improvementScintillate {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 5px #EF9A9A); }
        }

        details > summary { list-style: none; cursor: pointer; padding: 1rem 1.5rem; background-color: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 0.5rem; transition: background-color 0.2s ease-out, border-radius 0.3s ease-in-out; display: flex; justify-content: space-between; align-items: center; }
        details > summary:hover { background-color: #f5f5f5; }
        details > summary::-webkit-details-marker { display: none; }
        details .accordion-content { padding: 0; border: 1px solid #E0E0E0; border-top: none; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #FFFFFF; overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s ease-in-out 0.1s, padding-top 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), padding-bottom 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        details[open] > summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; background-color: #E8EAF6; }
        details[open] .accordion-content { max-height: 3000px; opacity: 1; padding-top: 1.5rem; padding-bottom: 1.5rem; padding-left: 1.5rem; padding-right: 1.5rem; }
        .accordion-icon { transition: transform 0.3s ease-in-out; }
        details[open] .accordion-icon { transform: rotate(90deg); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-close-button { background-color: #D32F2F; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer; margin-top: 1.5rem; transition: background-color 0.2s; }
        .modal-close-button:hover { background-color: #B71C1C; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #D32F2F; animation: spin 1s ease infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-field-template { display: none !important; }
        .context-entry-counter { font-size: 0.875rem; padding: 0.5rem 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; transition: background-color 0.3s, border-color 0.3s; }
        .context-description { font-size: 0.875rem; color: #424242; margin-bottom: 1rem; padding: 0.75rem; background-color: #F5F5F5; border-radius: 0.375rem; border-left: 4px solid #C8E6C9; }
        
        .card.card-limit-reached {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Reset to default shadow */
            transform: scale(1); /* Reset scale */
        }
        .card.card-limit-reached textarea {
            cursor: not-allowed;
            pointer-events: none; /* Ensure no interaction */
        }
        .card.card-limit-reached:focus-within { /* Prevent focus effect when limit is reached */
            transform: scale(1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .feedback-summary-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }
        .feedback-summary-star {
            font-size: 1.5em; /* Bigger star */
            margin-right: 0.5rem;
        }
        #personalizedMessageContainer p {
            font-style: italic;
            color: #4A5568; /* Tailwind gray-700 */
            /* Style for the personalized message, can be adjusted */
        }
         #personalizedMessageContainer p strong {
            color: #4C51BF; /* Tailwind indigo-700 for the number, or your preferred blue */
            font-weight: 700; /* Poppins bold */
        }

    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="spinner"></div>
        <p class="ml-3 text-gray-700">Chargement...</p>
    </div>

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <header id="mainHeader" class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800">Feedback Anonyme et Bienveillant</h1>
            <p class="text-lg text-gray-600 mt-3">Vos retours sont pr√©cieux. Merci de faire preuve de franchise et de bienveillance.</p>
            <p class="text-lg text-gray-600 mt-2">L√¢chez-vous, mais pas trop ! üòâ</p>
        </header>

        <form id="feedbackForm" name="feedback" netlify class="space-y-6">
            <input type="hidden" name="form-name" value="feedback" />
            
            <div class="hidden-field-template">
                <input type="text" name="Atout-vulgarisation-1" value=""><input type="text" name="Atout-vulgarisation-2" value=""><input type="text" name="Atout-vulgarisation-3" value=""><input type="text" name="Atout-vulgarisation-4" value=""><input type="text" name="Atout-vulgarisation-5" value="">
                <input type="text" name="Amelioration-vulgarisation-1" value=""><input type="text" name="Amelioration-vulgarisation-2" value=""><input type="text" name="Amelioration-vulgarisation-3" value=""><input type="text" name="Amelioration-vulgarisation-4" value=""><input type="text" name="Amelioration-vulgarisation-5" value="">
                <input type="text" name="Atout-interaction-1" value=""><input type="text" name="Atout-interaction-2" value=""><input type="text" name="Atout-interaction-3" value=""><input type="text" name="Atout-interaction-4" value=""><input type="text" name="Atout-interaction-5" value="">
                <input type="text" name="Amelioration-interaction-1" value=""><input type="text" name="Amelioration-interaction-2" value=""><input type="text" name="Amelioration-interaction-3" value=""><input type="text" name="Amelioration-interaction-4" value=""><input type="text" name="Amelioration-interaction-5" value="">
                <input type="text" name="Atout-animation-1" value=""><input type="text" name="Atout-animation-2" value=""><input type="text" name="Atout-animation-3" value=""><input type="text" name="Atout-animation-4" value=""><input type="text" name="Atout-animation-5" value="">
                <input type="text" name="Amelioration-animation-1" value=""><input type="text" name="Amelioration-animation-2" value=""><input type="text" name="Amelioration-animation-3" value=""><input type="text" name="Amelioration-animation-4" value=""><input type="text" name="Amelioration-animation-5" value="">
                <input type="text" name="Atout-improvisation-1" value=""><input type="text" name="Atout-improvisation-2" value=""><input type="text" name="Atout-improvisation-3" value=""><input type="text" name="Atout-improvisation-4" value=""><input type="text" name="Atout-improvisation-5" value="">
                <input type="text" name="Amelioration-improvisation-1" value=""><input type="text" name="Amelioration-improvisation-2" value=""><input type="text" name="Amelioration-improvisation-3" value=""><input type="text" name="Amelioration-improvisation-4" value=""><input type="text" name="Amelioration-improvisation-5" value="">
                <input type="text" name="Atout-structuration-1" value=""><input type="text" name="Atout-structuration-2" value=""><input type="text" name="Atout-structuration-3" value=""><input type="text" name="Atout-structuration-4" value=""><input type="text" name="Atout-structuration-5" value="">
                <input type="text" name="Amelioration-structuration-1" value=""><input type="text" name="Amelioration-structuration-2" value=""><input type="text" name="Amelioration-structuration-3" value=""><input type="text" name="Amelioration-structuration-4" value=""><input type="text" name="Amelioration-structuration-5" value="">
                <input type="text" name="Atout-accompagnement-1" value=""><input type="text" name="Atout-accompagnement-2" value=""><input type="text" name="Atout-accompagnement-3" value=""><input type="text" name="Atout-accompagnement-4" value=""><input type="text" name="Atout-accompagnement-5" value="">
                <input type="text" name="Amelioration-accompagnement-1" value=""><input type="text" name="Amelioration-accompagnement-2" value=""><input type="text" name="Amelioration-accompagnement-3" value=""><input type="text" name="Amelioration-accompagnement-4" value=""><input type="text" name="Amelioration-accompagnement-5" value="">
                <input type="text" name="Atout-posture-1" value=""><input type="text" name="Atout-posture-2" value=""><input type="text" name="Atout-posture-3" value=""><input type="text" name="Atout-posture-4" value=""><input type="text" name="Atout-posture-5" value="">
                <input type="text" name="Amelioration-posture-1" value=""><input type="text" name="Amelioration-posture-2" value=""><input type="text" name="Amelioration-posture-3" value=""><input type="text" name="Amelioration-posture-4" value=""><input type="text" name="Amelioration-posture-5" value="">
                <input type="text" name="Atout-adaptabilite-1" value=""><input type="text" name="Atout-adaptabilite-2" value=""><input type="text" name="Atout-adaptabilite-3" value=""><input type="text" name="Atout-adaptabilite-4" value=""><input type="text" name="Atout-adaptabilite-5" value="">
                <input type="text" name="Amelioration-adaptabilite-1" value=""><input type="text" name="Amelioration-adaptabilite-2" value=""><input type="text" name="Amelioration-adaptabilite-3" value=""><input type="text" name="Amelioration-adaptabilite-4" value=""><input type="text" name="Amelioration-adaptabilite-5" value="">
                <input type="text" name="Atout-transmission-1" value=""><input type="text" name="Atout-transmission-2" value=""><input type="text" name="Atout-transmission-3" value=""><input type="text" name="Atout-transmission-4" value=""><input type="text" name="Atout-transmission-5" value="">
                <input type="text" name="Amelioration-transmission-1" value=""><input type="text" name="Amelioration-transmission-2" value=""><input type="text" name="Amelioration-transmission-3" value=""><input type="text" name="Amelioration-transmission-4" value=""><input type="text" name="Amelioration-transmission-5" value="">
                <input type="text" name="Atout-ouverture-1" value=""><input type="text" name="Atout-ouverture-2" value=""><input type="text" name="Atout-ouverture-3" value=""><input type="text" name="Atout-ouverture-4" value=""><input type="text" name="Atout-ouverture-5" value="">
                <input type="text" name="Amelioration-ouverture-1" value=""><input type="text" name="Amelioration-ouverture-2" value=""><input type="text" name="Amelioration-ouverture-3" value=""><input type="text" name="Amelioration-ouverture-4" value=""><input type="text" name="Amelioration-ouverture-5" value="">
                <input type="text" name="Atout-autre-1" value=""><input type="text" name="Atout-autre-2" value=""><input type="text" name="Atout-autre-3" value=""><input type="text" name="Atout-autre-4" value=""><input type="text" name="Atout-autre-5" value="">
                <input type="text" name="Amelioration-autre-1" value=""><input type="text" name="Amelioration-autre-2" value=""><input type="text" name="Amelioration-autre-3" value=""><input type="text" name="Amelioration-autre-4" value=""><input type="text" name="Amelioration-autre-5" value="">
                <input type="text" name="custom_context_name_autre" value="">
            </div>
            
            <div id="allContextsContainer" class="space-y-4">
                </div>

            <div class="mt-10 text-center">
                <button type="submit" id="submitButton" 
                        class="inline-flex items-center justify-center rounded-md border border-transparent px-8 py-3 
                               text-base font-medium text-white shadow-sm 
                               focus:outline-none focus:ring-2 focus:ring-offset-2 
                               transition-colors duration-150"
                        style="background-color: #D32F2F;"
                        onmouseover="this.style.backgroundColor='#B71C1C'"
                        onmouseout="this.style.backgroundColor='#D32F2F'">
                    Envoyer le feedback
                </button>
            </div>
        </form>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <div id="feedbackSummary" class="mt-4 text-center"></div>
            <div id="personalizedMessageContainer" class="mt-4 text-center"></div>
            <button id="modalCloseButton" class="modal-close-button">Fermer</button>
        </div>
    </div>

    <script type="module">
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const feedbackSummaryDiv = document.getElementById('feedbackSummary');
        const personalizedMessageContainerDiv = document.getElementById('personalizedMessageContainer');
        
        const thankYouMessages = [
            "Chaque retour est une boussole. Merci pour ces <strong>somme_√©toiles</strong> indications qui m'aident √† affiner la mienne !",
            "Je repars avec <strong>somme_√©toiles</strong> pistes concr√®tes pour progresser et mieux transmettre. Un grand merci !",
            "Ces <strong>somme_√©toiles</strong> retours sont autant de graines sem√©es. Certaines confirment mes racines, d'autres me poussent √† grandir diff√©remment. Merci pour votre regard.",
            "Votre perspective est un cadeau pr√©cieux. Merci pour ces <strong>somme_√©toiles</strong> √©clairages !",
            "Merci pour ces <strong>somme_√©toiles</strong> retours ! C'est avec des √©changes comme celui-ci que l'on avance.",
            "<strong>Somme_√©toiles</strong> √©toiles pour guider mes prochains pas. Un grand merci !",
            "Votre franchise est appr√©ci√©e. Ces <strong>somme_√©toiles</strong> retours vont m'√™tre tr√®s utiles.",
            "Merci d'avoir pris le temps de partager ces <strong>somme_√©toiles</strong> r√©flexions constructives.",
            "C'est not√© ! <strong>Somme_√©toiles</strong> points √† m√©diter et √† travailler. Merci beaucoup.",
            "<strong>Somme_√©toiles</strong> p√©pites d'or dans vos retours. Merci pour votre g√©n√©rosit√© !",
            "Votre feedback est une source d'inspiration. Merci pour ces <strong>somme_√©toiles</strong> contributions !",
            "Je suis touch√©(e) par la qualit√© de vos <strong>somme_√©toiles</strong> retours. Merci !",
            "Merci pour ce miroir ! <strong>Somme_√©toiles</strong> reflets qui vont m'aider √† √©voluer.",
            "Ces <strong>somme_√©toiles</strong> observations sont tr√®s pertinentes. Merci de m'aider √† voir plus clair.",
            "Un grand merci pour ces <strong>somme_√©toiles</strong> partages, c'est tr√®s enrichissant.",
            "Chaque feedback est une chance de s'am√©liorer. Merci pour ces <strong>somme_√©toiles</strong> opportunit√©s !",
            "<strong>Somme_√©toiles</strong> nouvelles perspectives gr√¢ce √† vous. Merci infiniment !",
            "Votre regard ext√©rieur est essentiel. Merci pour ces <strong>somme_√©toiles</strong> points de vue.",
            "Merci pour votre temps et ces <strong>somme_√©toiles</strong> retours d√©taill√©s.",
            "C'est gr√¢ce √† des retours comme les v√¥tres (<strong>somme_√©toiles</strong> au total !) que je peux m'ajuster.",
            "<strong>Somme_√©toiles</strong> encouragements et pistes √† explorer. Merci pour cet √©lan !",
            "Je prends note de chaque √©toile. Merci pour ces <strong>somme_√©toiles</strong> pr√©cieux conseils.",
            "Votre contribution est tr√®s appr√©ci√©e. Merci pour ces <strong>somme_√©toiles</strong> retours !",
            "Merci de m'offrir <strong>somme_√©toiles</strong> directions pour m'am√©liorer.",
            "Ces <strong>somme_√©toiles</strong> retours sont une vraie mine d'informations. Merci !",
            "Un immense merci pour votre implication et ces <strong>somme_√©toiles</strong> feedbacks.",
            "<strong>Somme_√©toiles</strong> points qui vont nourrir ma r√©flexion. Merci pour votre aide !",
            "Je suis reconnaissant(e) pour ces <strong>somme_√©toiles</strong> partages. Merci !",
            "Votre feedback compte beaucoup. Merci pour ces <strong>somme_√©toiles</strong> √©toiles !",
            "Merci pour ce regard constructif et ces <strong>somme_√©toiles</strong> pistes de d√©veloppement.",
            "Avec <strong>somme_√©toiles</strong> retours comme ceux-ci, le chemin de l'am√©lioration est plus clair. Merci !",
            "Ces <strong>somme_√©toiles</strong> points de vue sont comme des phares dans la nuit. Merci !",
            "Merci d'avoir partag√© <strong>somme_√©toiles</strong> pens√©es si constructives !"
        ];

        function showModal(title, message, onCloseButtonClickCallback, atoutsCount, ameliorationsCount, personalizedMessageText) {
            if (modalTitle && modalMessage && messageModal && modalCloseButton && feedbackSummaryDiv && personalizedMessageContainerDiv) { 
                modalTitle.textContent = title;
                modalMessage.innerHTML = message; 
                
                let summaryHTML = "";
                if (typeof atoutsCount === 'number' && typeof ameliorationsCount === 'number' && (atoutsCount > 0 || ameliorationsCount > 0)) {
                    summaryHTML += `<div class="mt-6 border-t pt-4">`;
                    summaryHTML += `<h4 class="text-lg font-semibold text-gray-700 mb-3">R√©capitulatif de vos retours :</h4>`;
                    if (atoutsCount > 0) {
                        summaryHTML += `<div class="feedback-summary-line"><span class="feedback-summary-star" style="color: #4CAF50;">&#x2605;</span> Atouts soumis : <strong>${atoutsCount}</strong></div>`;
                    }
                    if (ameliorationsCount > 0) {
                        summaryHTML += `<div class="feedback-summary-line"><span class="feedback-summary-star" style="color: #F44336;">&#x2605;</span> Am√©liorations soumises : <strong>${ameliorationsCount}</strong></div>`;
                    }
                    summaryHTML += `</div>`;
                }
                feedbackSummaryDiv.innerHTML = summaryHTML;

                if (personalizedMessageText) {
                    personalizedMessageContainerDiv.innerHTML = `<p class="text-md text-indigo-700 mt-4 pt-4 border-t">${personalizedMessageText}</p>`; // Removed font-semibold for a softer look, kept indigo
                } else {
                    personalizedMessageContainerDiv.innerHTML = ""; 
                }
                
                messageModal.style.display = "flex"; 

                modalCloseButton.onclick = typeof onCloseButtonClickCallback === 'function' 
                    ? onCloseButtonClickCallback 
                    : () => { if(messageModal) messageModal.style.display = "none"; };
            } else {
                console.error("Modal elements not found. Cannot display message:", title, message);
                alert(title + "\n\n" + message.replace(/<br\s*\/?>/gi, "\n"));
            }
        }
        
        window.onclick = (event) => {
            if (event.target == messageModal && messageModal) {
                messageModal.style.display = "none";
                 if(modalCloseButton) modalCloseButton.textContent = "Fermer";
                 if(feedbackSummaryDiv) feedbackSummaryDiv.innerHTML = ""; 
                 if(personalizedMessageContainerDiv) personalizedMessageContainerDiv.innerHTML = "";
            }
        }
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const feedbackForm = document.getElementById('feedbackForm'); 
        const allContextsContainer = document.getElementById('allContextsContainer');
        const submitButton = document.getElementById('submitButton');
        const mainHeaderDiv = document.getElementById('mainHeader'); 

        const contexts = [
            { id: "vulgarisation", label: "Vulgarisation", description: "Explication d‚Äôun concept complexe √† un public non technique" },
            { id: "interaction", label: "Interaction", description: "Relations avec les participants (√©coute, encouragements, questions)" },
            { id: "animation", label: "Animation", description: "Dynamisme et engagement pendant la session" },
            { id: "improvisation", label: "Improvisation", description: "R√©actions en cas d‚Äôimpr√©vus ou de bugs techniques" },
            { id: "structuration", label: "Structuration", description: "Clart√© et logique du d√©roul√© p√©dagogique" },
            { id: "accompagnement", label: "Accompagnement", description: "Aide apport√©e lors des exercices ou ateliers pratiques" },
            { id: "posture", label: "Posture", description: "Attitude g√©n√©rale (professionnalisme, accessibilit√©, cr√©dibilit√©)" },
            { id: "adaptabilite", label: "Adaptabilit√©", description: "Ajustements faits selon le niveau ou les besoins du groupe" },
            { id: "transmission", label: "Transmission", description: "Impact sur la motivation et l‚Äôenvie de continuer apr√®s la session" },
            { id: "ouverture", label: "Ouverture", description: "R√©ceptivit√© aux retours, critiques et suggestions" },
            { id: "autre", label: "Autre (√† pr√©ciser)", description: "Si vous avez un retour sur un autre aspect non list√©." }
        ];
        
        const MAX_CHARS_PER_CARD = 250;
        const CARDS_PER_AXE = 5; 
        const MAX_ENTRIES_PER_CONTEXT = 5; 

        function createCard(type, contextId, cardIndex) {
            const cardElement = document.createElement('div');
            cardElement.className = `card ${type === 'Atout' ? 'strength-card' : 'improvement-card'}`;
            cardElement.dataset.contextId = contextId; 

            const textareaWrapper = document.createElement('div');
            textareaWrapper.className = 'textarea-wrapper flex-grow flex flex-col'; 

            const textarea = document.createElement('textarea');
            textarea.name = `${type}-${contextId}-${cardIndex + 1}`;
            textarea.placeholder = `${type} #${cardIndex + 1}`;
            textarea.maxLength = MAX_CHARS_PER_CARD;
            textarea.className = 'flex-grow'; 
            
            const charCounter = document.createElement('div');
            charCounter.className = 'char-counter';
            charCounter.textContent = `0 / ${MAX_CHARS_PER_CARD}`;

            textareaWrapper.appendChild(textarea);
            textareaWrapper.appendChild(charCounter);

            const starDisplay = document.createElement('div');
            starDisplay.className = `star-display ${type === 'Atout' ? 'strength-star' : 'improvement-star'}`;
            starDisplay.innerHTML = '&#x2605;'; 
            starDisplay.style.display = 'none'; 


            textarea.addEventListener('input', () => {
                charCounter.textContent = `${textarea.value.length} / ${MAX_CHARS_PER_CARD}`;
                updateContextEntryCounter(contextId); 
            });

            textarea.addEventListener('blur', () => {
                if (textarea.value.trim() !== '') {
                    cardElement.classList.add('is-star');
                    textareaWrapper.style.opacity = '0';
                    textareaWrapper.style.pointerEvents = 'none';
                    textareaWrapper.style.height = '0'; 
                    textareaWrapper.style.overflow = 'hidden'; 
                    starDisplay.style.display = 'flex';
                    starDisplay.style.opacity = '1';
                    starDisplay.style.pointerEvents = 'auto';
                }
                updateContextEntryCounter(contextId); 
            });

            starDisplay.addEventListener('click', () => {
                cardElement.classList.remove('is-star');
                textareaWrapper.style.opacity = '1';
                textareaWrapper.style.pointerEvents = 'auto';
                textareaWrapper.style.height = ''; 
                textareaWrapper.style.overflow = ''; 
                starDisplay.style.display = 'none';
                starDisplay.style.opacity = '0';
                starDisplay.style.pointerEvents = 'none';
                textarea.focus();
                updateContextEntryCounter(contextId); 
            });
            
            cardElement.appendChild(textareaWrapper);
            cardElement.appendChild(starDisplay);
            return cardElement;
        }

        function countFilledCardsForContext(contextId) {
            const contextBlock = document.getElementById(`context-block-${contextId}`);
            if (!contextBlock) return 0;
            let filledCount = 0;
            contextBlock.querySelectorAll('.card').forEach(card => {
                const textarea = card.querySelector('textarea');
                if ((textarea && textarea.value.trim() !== '') || card.classList.contains('is-star')) {
                    filledCount++;
                }
            });
            return filledCount;
        }

        function updateContextEntryCounter(contextId) {
            const counterDisplay = document.getElementById(`filledCountDisplay-${contextId}`);
            const counterContainer = document.getElementById(`entryCounter-${contextId}`);
            if (!counterDisplay || !counterContainer) return;

            const totalFilled = countFilledCardsForContext(contextId);
            counterDisplay.textContent = totalFilled;

            const contextBlock = document.getElementById(`context-block-${contextId}`);
            if (!contextBlock) return;
            const allCardsInContext = contextBlock.querySelectorAll('.card');

            if (totalFilled >= MAX_ENTRIES_PER_CONTEXT) {
                counterDisplay.classList.add('count-error');
                counterDisplay.classList.remove('count-valid');
                counterContainer.classList.add('bg-red-100', 'border-red-300'); 
                counterContainer.classList.remove('bg-indigo-50', 'border-indigo-200');

                allCardsInContext.forEach(card => {
                    const textarea = card.querySelector('textarea');
                    if (!card.classList.contains('is-star') && textarea && textarea.value.trim() === '') {
                        card.classList.add('card-limit-reached');
                        textarea.disabled = true;
                    }
                });

            } else {
                counterDisplay.classList.remove('count-error');
                counterDisplay.classList.add('count-valid');
                counterContainer.classList.add('bg-indigo-50', 'border-indigo-200');
                counterContainer.classList.remove('bg-red-100', 'border-red-300');

                allCardsInContext.forEach(card => {
                    card.classList.remove('card-limit-reached');
                    const textarea = card.querySelector('textarea');
                    if (textarea) {
                        textarea.disabled = false;
                    }
                });
            }
        }
        
        function renderAllContexts() {
            if (!allContextsContainer) return;
            allContextsContainer.innerHTML = ''; 
            const allDetailsElements = []; 

            contexts.forEach(context => {
                const details = document.createElement('details');
                details.className = 'accordion-item bg-white rounded-lg shadow-md'; 
                allDetailsElements.push(details); 

                const summary = document.createElement('summary');
                summary.className = 'accordion-title text-lg font-semibold p-5 flex justify-between items-center cursor-pointer hover:bg-gray-100 rounded-t-lg';
                summary.innerHTML = `
                    <span>${context.label}</span>
                    <svg class="accordion-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content'; 
                content.id = `context-block-${context.id}`;

                const descriptionP = document.createElement('p');
                descriptionP.className = 'context-description';
                descriptionP.textContent = context.description;
                content.appendChild(descriptionP);

                if (context.id === 'autre') {
                    const customContextInputDiv = document.createElement('div');
                    customContextInputDiv.className = 'mb-6 pt-2'; 
                    customContextInputDiv.innerHTML = `
                        <label for="custom_context_name_${context.id}" class="block text-sm font-medium text-gray-700 mb-1">Pr√©cisez le nom de cet "Autre contexte" :</label>
                        <input type="text" name="custom_context_name_${context.id}" id="custom_context_name_${context.id}" placeholder="Nom du contexte personnalis√©" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    `;
                    content.appendChild(customContextInputDiv);
                }

                const entryCounterDiv = document.createElement('div');
                entryCounterDiv.id = `entryCounter-${context.id}`;
                entryCounterDiv.className = 'context-entry-counter text-center bg-indigo-50 border border-indigo-200'; 
                entryCounterDiv.innerHTML = `Saisies pour ce contexte : <span id="filledCountDisplay-${context.id}" class="count-display">0</span> / ${MAX_ENTRIES_PER_CONTEXT} (max)`;
                content.appendChild(entryCounterDiv);

                const strengthsSection = document.createElement('div');
                strengthsSection.className = 'mt-4';
                strengthsSection.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-3 text-center">Atouts</h3>`;
                
                const strengthsRow1 = document.createElement('div');
                strengthsRow1.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4';
                for(let i=0; i < 3; i++) strengthsRow1.appendChild(createCard('Atout', context.id, i));
                strengthsSection.appendChild(strengthsRow1);

                const strengthsRow2 = document.createElement('div');
                strengthsRow2.className = 'flex justify-center gap-4 flex-wrap'; 
                for(let i=3; i < CARDS_PER_AXE; i++) strengthsRow2.appendChild(createCard('Atout', context.id, i));
                strengthsSection.appendChild(strengthsRow2);
                content.appendChild(strengthsSection);

                const improvementsSection = document.createElement('div');
                improvementsSection.className = 'mt-8'; 
                improvementsSection.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-3 text-center">Am√©liorations</h3>`;

                const improvementsRow1 = document.createElement('div');
                improvementsRow1.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4';
                for(let i=0; i < 3; i++) improvementsRow1.appendChild(createCard('Amelioration', context.id, i));
                improvementsSection.appendChild(improvementsRow1);

                const improvementsRow2 = document.createElement('div');
                improvementsRow2.className = 'flex justify-center gap-4 flex-wrap';
                for(let i=3; i < CARDS_PER_AXE; i++) improvementsRow2.appendChild(createCard('Amelioration', context.id, i));
                improvementsSection.appendChild(improvementsRow2);
                content.appendChild(improvementsSection);

                details.appendChild(summary);
                details.appendChild(content);
                allContextsContainer.appendChild(details);
                
                updateContextEntryCounter(context.id);

                details.addEventListener('toggle', (event) => {
                    if (details.open) {
                        setTimeout(() => {
                            details.scrollIntoView({ behavior: "smooth", block: "start" });
                        }, 100); 

                        allDetailsElements.forEach(otherDetails => {
                            if (otherDetails !== details && otherDetails.open) {
                                otherDetails.open = false;
                            }
                        });
                    }
                });
            });
            if(submitButton) submitButton.disabled = false; 
        }
        
        if(feedbackForm) {
            feedbackForm.addEventListener('submit', async (event) => {
                event.preventDefault(); 
                
                let formIsValid = true;
                let firstInvalidContextLabel = "";
                for (const context of contexts) {
                    const filledCount = countFilledCardsForContext(context.id);
                    if (filledCount > MAX_ENTRIES_PER_CONTEXT) {
                        formIsValid = false;
                        firstInvalidContextLabel = context.label;
                        const problemAccordion = document.getElementById(`entryCounter-${context.id}`);
                        if(problemAccordion) {
                            problemAccordion.scrollIntoView({behavior: "smooth", block: "center"});
                            const detailsElement = problemAccordion.closest('details');
                            if (detailsElement && !detailsElement.open) {
                                detailsElement.open = true;
                            }
                        }
                        break; 
                    }
                }

                if (!formIsValid) {
                    showModal("Validation √âchou√©e", `Pour le contexte "${firstInvalidContextLabel}", vous avez saisi plus de ${MAX_ENTRIES_PER_CONTEXT} descriptions. Veuillez corriger.`);
                    if(modalCloseButton) modalCloseButton.textContent = "Fermer";
                    return;
                }
                
                if(submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="spinner !w-6 !h-6 !border-2 inline-block mr-2"></div>Envoi en cours...';
                }

                const processedFormData = new FormData();
                processedFormData.append('form-name', feedbackForm.getAttribute('name') || 'feedback');
                
                let totalAtoutsSubmittedForSummary = 0;
                let totalAmeliorationsSubmittedForSummary = 0;

                feedbackForm.querySelectorAll('textarea').forEach(textarea => {
                    const value = textarea.value.trim();
                    if (value) { 
                        processedFormData.append(textarea.name, value);
                        if (textarea.name.startsWith('Atout-')) {
                            totalAtoutsSubmittedForSummary++;
                        } else if (textarea.name.startsWith('Amelioration-')) {
                            totalAmeliorationsSubmittedForSummary++;
                        }
                    }
                });
                const customContextNameInput = document.getElementById('custom_context_name_autre');
                if(customContextNameInput && customContextNameInput.value.trim()){
                    processedFormData.append(customContextNameInput.name, customContextNameInput.value.trim());
                }
                
                const totalSubmittedStars = totalAtoutsSubmittedForSummary + totalAmeliorationsSubmittedForSummary;
                let personalizedMessage = "";
                if (totalSubmittedStars > 0) {
                    const randomIndex = Math.floor(Math.random() * thankYouMessages.length);
                    personalizedMessage = thankYouMessages[randomIndex].replace('somme_√©toiles', `<strong>${totalSubmittedStars}</strong>`);
                } else {
                    personalizedMessage = "Merci d'avoir pris le temps de consulter ce formulaire.";
                }


                const body = new URLSearchParams(processedFormData).toString();

                try {
                    const response = await fetch("/", { 
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body,
                    });

                    if (response.ok) {
                        console.log("Feedback soumis avec succ√®s √† Netlify.");
                        
                        const successModalCloseAction = () => {
                            const newWindow = window.open('about:blank', '_self');
                            if (newWindow) { newWindow.close(); }
                            if (messageModal) messageModal.style.display = "none"; 
                        };
                        
                        if(modalCloseButton) modalCloseButton.textContent = "Fermer la page";
                        showModal(
                            "Merci infiniment !", 
                            "Votre feedback a √©t√© soumis avec succ√®s. Vos retours sont pr√©cieux pour nous aider √† nous am√©liorer. Vous pouvez maintenant fermer cette page.", 
                            successModalCloseAction,
                            totalAtoutsSubmittedForSummary,
                            totalAmeliorationsSubmittedForSummary,
                            personalizedMessage
                        );
                        
                        if(feedbackForm) feedbackForm.style.display = 'none';
                        if(mainHeaderDiv) mainHeaderDiv.style.display = 'none'; 

                    } else {
                        const errorText = await response.text();
                        console.error("Erreur de soumission √† Netlify:", response.status, errorText);
                        showModal("Erreur de Soumission", `Une erreur est survenue (status: ${response.status}). Veuillez r√©essayer ou nous contacter si le probl√®me persiste.`);
                        if(modalCloseButton) modalCloseButton.textContent = "Fermer"; 
                    }
                } catch (error) {
                    console.error("Erreur de r√©seau ou autre lors de la soumission √† Netlify:", error);
                    showModal("Erreur de Soumission", "Une erreur de r√©seau est survenue. Veuillez v√©rifier votre connexion et r√©essayer.");
                    if(modalCloseButton) modalCloseButton.textContent = "Fermer"; 
                } finally {
                     if(submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Envoyer le feedback';
                    }
                }
            });
        }

        function main() {
            if(feedbackForm) feedbackForm.style.display = 'block'; 
            if(mainHeaderDiv) mainHeaderDiv.style.display = 'block'; 
            
            renderAllContexts(); 
            
            if(loadingOverlay) loadingOverlay.style.display = 'none';
        }
        
        main(); 
        
    </script>
</body>
</html>
