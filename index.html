<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Feedback Anonyme et Bienveillant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAFAFA;
            color: #212121;
        }
        h1, h2, h3, summary { /* Apply Poppins to summary as well for accordion titles */
            font-family: 'Poppins', sans-serif;
        }
        .card {
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1rem;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .card textarea {
            flex-grow: 1;
            background-color: transparent;
            /* R√©initialisation de bordure plus explicite et agressive */
            border: none !important; /* Assure la suppression de toute bordure */
            outline: none !important; /* Assure la suppression de tout contour */
            box-shadow: none !important; /* Assure la suppression de toute ombre */
            
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;

            resize: none;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: #212121; 
        }
        .card:focus-within { /* Appliquer l'effet de focus sur la carte enti√®re lorsque le textarea est focus */
            transform: scale(1.03);
            box-shadow: 0 0 0 3px var(--focus-ring-color, #C8E6C9), 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-lg */
        }
        /* Retirer le :focus sp√©cifique sur textarea s'il cr√©e un double effet avec :focus-within sur .card */
        /* .card textarea:focus { ... } */

        .strength-card {
            background-color: #E8F5E9;
            --focus-ring-color: #A5D6A7; 
        }
        .improvement-card {
            background-color: #FDECEA;
            --focus-ring-color: #EF9A9A; 
        }
        .char-counter {
            font-size: 0.75rem; /* text-xs */
            text-align: right;
            color: #757575; /* gray-500 */
            margin-top: 0.25rem; /* mt-1 */
        }

        details > summary {
            list-style: none; 
            cursor: pointer;
            padding: 1rem 1.5rem;
            background-color: #FFFFFF; 
            border: 1px solid #E0E0E0; 
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-out, border-radius 0.3s ease-in-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details > summary:hover {
            background-color: #f5f5f5; 
        }
        details > summary::-webkit-details-marker {
            display: none; 
        }
        details .accordion-content {
            padding: 0; /* Padding will be applied to inner content for better transition */
            border: 1px solid #E0E0E0;
            border-top: none;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            background-color: #FFFFFF;
            overflow: hidden; 
            max-height: 0;
            opacity: 0;
            transition: max-height 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), 
                        opacity 0.3s ease-in-out 0.1s,
                        padding-top 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), 
                        padding-bottom 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        details[open] > summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            background-color: #E8EAF6; 
        }
        details[open] .accordion-content {
            max-height: 3000px; /* Increased to accommodate content */
            opacity: 1;
            padding-top: 1.5rem; /* Apply padding when open */
            padding-bottom: 1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        details[open] .accordion-icon {
            transform: rotate(90deg);
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); 
            align-items: center; justify-content: center; /* For centering modal content */
        }
        .modal-content {
            background-color: #fefefe; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-close-button {
            background-color: #D32F2F; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer; margin-top: 1.5rem; transition: background-color 0.2s;
        }
        .modal-close-button:hover {
            background-color: #B71C1C;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #D32F2F; animation: spin 1s ease infinite; margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden-field-template { display: none !important; }
        .context-entry-counter {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 0.75rem; /* p-2 py-1 */
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 1rem; /* mb-4 */
            transition: background-color 0.3s, border-color 0.3s;
        }
        .context-description {
            font-size: 0.875rem; /* text-sm */
            color: #424242; /* gray-700 */
            margin-bottom: 1rem; /* mb-4 */
            padding: 0.75rem; /* p-3 */
            background-color: #F5F5F5; /* gray-100 */
            border-radius: 0.375rem; /* rounded-md */
            border-left: 4px solid #C8E6C9; /* Accent color */
        }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="spinner"></div>
        <p class="ml-3 text-gray-700">Chargement...</p>
    </div>

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <header id="mainHeader" class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800">Feedback Anonyme et Bienveillant</h1>
            <p class="text-lg text-gray-600 mt-3">Vos retours sont pr√©cieux. Merci de faire preuve de franchise et de bienveillance.</p>
            <p class="text-lg text-gray-600 mt-2">L√¢chez-vous, mais pas trop ! üòâ</p>
        </header>

        <form id="feedbackForm" name="feedback" netlify class="space-y-6">
            <input type="hidden" name="form-name" value="feedback" />
            
            <div class="hidden-field-template">
                <input type="text" name="strength-vulgarisation-0" value="">
                <input type="text" name="improvement-vulgarisation-0" value="">
                <input type="text" name="custom_context_name_autre" value="">
            </div>
            
            <div id="allContextsContainer" class="space-y-4">
                <!-- Accordions will be injected here by JavaScript -->
            </div>

            <div class="mt-10 text-center">
                <button type="submit" id="submitButton" 
                        class="inline-flex items-center justify-center rounded-md border border-transparent px-8 py-3 
                               text-base font-medium text-white shadow-sm 
                               focus:outline-none focus:ring-2 focus:ring-offset-2 
                               transition-colors duration-150"
                        style="background-color: #D32F2F;"
                        onmouseover="this.style.backgroundColor='#B71C1C'"
                        onmouseout="this.style.backgroundColor='#D32F2F'">
                    Envoyer le feedback
                </button>
            </div>
        </form>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <button id="modalCloseButton" class="modal-close-button">Fermer</button>
        </div>
    </div>

    <script type="module">
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        
        function showModal(title, message, onCloseButtonClickCallback) {
            if (modalTitle && modalMessage && messageModal && modalCloseButton) { 
                modalTitle.textContent = title;
                modalMessage.innerHTML = message; 
                messageModal.style.display = "flex"; 

                modalCloseButton.onclick = typeof onCloseButtonClickCallback === 'function' 
                    ? onCloseButtonClickCallback 
                    : () => { if(messageModal) messageModal.style.display = "none"; };
            } else {
                console.error("Modal elements not found. Cannot display message:", title, message);
                alert(title + "\n\n" + message.replace(/<br\s*\/?>/gi, "\n"));
            }
        }
        
        window.onclick = (event) => {
            if (event.target == messageModal && messageModal) {
                messageModal.style.display = "none";
                 if(modalCloseButton) modalCloseButton.textContent = "Fermer";
            }
        }
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const feedbackForm = document.getElementById('feedbackForm'); 
        const allContextsContainer = document.getElementById('allContextsContainer');
        const submitButton = document.getElementById('submitButton');
        const mainHeaderDiv = document.getElementById('mainHeader'); 

        const contexts = [
            { id: "vulgarisation", label: "Vulgarisation", description: "Explication d‚Äôun concept complexe √† un public non technique" },
            { id: "interaction", label: "Interaction", description: "Relations avec les participants (√©coute, encouragements, questions)" },
            { id: "animation", label: "Animation", description: "Dynamisme et engagement pendant la session" },
            { id: "improvisation", label: "Improvisation", description: "R√©actions en cas d‚Äôimpr√©vus ou de bugs techniques" },
            { id: "structuration", label: "Structuration", description: "Clart√© et logique du d√©roul√© p√©dagogique" },
            { id: "accompagnement", label: "Accompagnement", description: "Aide apport√©e lors des exercices ou ateliers pratiques" },
            { id: "posture", label: "Posture", description: "Attitude g√©n√©rale (professionnalisme, accessibilit√©, cr√©dibilit√©)" },
            { id: "adaptabilite", label: "Adaptabilit√©", description: "Ajustements faits selon le niveau ou les besoins du groupe" },
            { id: "transmission", label: "Transmission", description: "Impact sur la motivation et l‚Äôenvie de continuer apr√®s la session" },
            { id: "ouverture", label: "Ouverture", description: "R√©ceptivit√© aux retours, critiques et suggestions" },
            { id: "autre", label: "Autre (√† pr√©ciser)", description: "Si vous avez un retour sur un autre aspect non list√©." }
        ];
        
        const MAX_CHARS_PER_CARD = 250;
        const CARDS_PER_AXE = 5; 
        const MAX_ENTRIES_PER_CONTEXT = 5; 

        function createCard(type, contextId, cardIndex) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${type === 'strength' ? 'strength-card' : 'improvement-card'}`;
            
            const textarea = document.createElement('textarea');
            textarea.name = `${type === 'strength' ? 'strength' : 'improvement'}-${contextId}-${cardIndex}`;
            textarea.placeholder = type === 'strength' ? `Atout #${cardIndex + 1}` : `Am√©lioration #${cardIndex + 1}`;
            textarea.maxLength = MAX_CHARS_PER_CARD;
            
            const charCounter = document.createElement('div');
            charCounter.className = 'char-counter';
            charCounter.textContent = `0 / ${MAX_CHARS_PER_CARD}`;

            textarea.addEventListener('input', () => {
                charCounter.textContent = `${textarea.value.length} / ${MAX_CHARS_PER_CARD}`;
                updateContextEntryCounter(contextId); 
            });

            cardDiv.appendChild(textarea);
            cardDiv.appendChild(charCounter);
            return cardDiv;
        }

        function countFilledCardsForContext(contextId) {
            const contextBlock = document.getElementById(`context-block-${contextId}`);
            if (!contextBlock) return 0;

            const filledStrengthsCount = Array.from(contextBlock.querySelectorAll('textarea[name^="strength-"]'))
                                         .filter(textarea => textarea.value.trim() !== '').length;
            const filledImprovementsCount = Array.from(contextBlock.querySelectorAll('textarea[name^="improvement-"]'))
                                          .filter(textarea => textarea.value.trim() !== '').length;
            return filledStrengthsCount + filledImprovementsCount;
        }

        function updateContextEntryCounter(contextId) {
            const counterDisplay = document.getElementById(`filledCountDisplay-${contextId}`);
            const counterContainer = document.getElementById(`entryCounter-${contextId}`);
            if (!counterDisplay || !counterContainer) return;

            const totalFilled = countFilledCardsForContext(contextId);
            counterDisplay.textContent = totalFilled;

            if (totalFilled > MAX_ENTRIES_PER_CONTEXT) {
                counterDisplay.classList.add('count-error');
                counterDisplay.classList.remove('count-valid');
                counterContainer.classList.add('bg-red-100', 'border-red-300'); 
                counterContainer.classList.remove('bg-indigo-50', 'border-indigo-200');
            } else {
                counterDisplay.classList.remove('count-error');
                counterDisplay.classList.add('count-valid');
                counterContainer.classList.add('bg-indigo-50', 'border-indigo-200');
                counterContainer.classList.remove('bg-red-100', 'border-red-300');
            }
        }
        
        function renderAllContexts() {
            if (!allContextsContainer) return;
            allContextsContainer.innerHTML = ''; 
            const allDetailsElements = []; // Keep a list of all <details> elements

            contexts.forEach(context => {
                const details = document.createElement('details');
                details.className = 'accordion-item bg-white rounded-lg shadow-md'; 
                allDetailsElements.push(details); // Add to the list

                const summary = document.createElement('summary');
                summary.className = 'accordion-title text-lg font-semibold p-5 flex justify-between items-center cursor-pointer hover:bg-gray-100 rounded-t-lg';
                summary.innerHTML = `
                    <span>${context.label}</span>
                    <svg class="accordion-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content'; 
                content.id = `context-block-${context.id}`;

                const descriptionP = document.createElement('p');
                descriptionP.className = 'context-description';
                descriptionP.textContent = context.description;
                content.appendChild(descriptionP);

                if (context.id === 'autre') {
                    const customContextInputDiv = document.createElement('div');
                    customContextInputDiv.className = 'mb-6 pt-2'; 
                    customContextInputDiv.innerHTML = `
                        <label for="custom_context_name_${context.id}" class="block text-sm font-medium text-gray-700 mb-1">Pr√©cisez le nom de cet "Autre contexte" :</label>
                        <input type="text" name="custom_context_name_${context.id}" id="custom_context_name_${context.id}" placeholder="Nom du contexte personnalis√©" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    `;
                    content.appendChild(customContextInputDiv);
                }

                const entryCounterDiv = document.createElement('div');
                entryCounterDiv.id = `entryCounter-${context.id}`;
                entryCounterDiv.className = 'context-entry-counter text-center bg-indigo-50 border border-indigo-200'; 
                entryCounterDiv.innerHTML = `Saisies pour ce contexte : <span id="filledCountDisplay-${context.id}" class="count-display">0</span> / ${MAX_ENTRIES_PER_CONTEXT} (max)`;
                content.appendChild(entryCounterDiv);

                const strengthsSection = document.createElement('div');
                strengthsSection.className = 'mt-4';
                strengthsSection.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-3 text-center">Atouts</h3>`;
                
                const strengthsRow1 = document.createElement('div');
                strengthsRow1.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4';
                for(let i=0; i < 3; i++) strengthsRow1.appendChild(createCard('strength', context.id, i));
                strengthsSection.appendChild(strengthsRow1);

                const strengthsRow2 = document.createElement('div');
                strengthsRow2.className = 'flex justify-center gap-4 flex-wrap'; 
                for(let i=3; i < CARDS_PER_AXE; i++) strengthsRow2.appendChild(createCard('strength', context.id, i));
                strengthsSection.appendChild(strengthsRow2);
                content.appendChild(strengthsSection);

                const improvementsSection = document.createElement('div');
                improvementsSection.className = 'mt-8'; 
                improvementsSection.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-3 text-center">Am√©liorations</h3>`;

                const improvementsRow1 = document.createElement('div');
                improvementsRow1.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4';
                for(let i=0; i < 3; i++) improvementsRow1.appendChild(createCard('improvement', context.id, i));
                improvementsSection.appendChild(improvementsRow1);

                const improvementsRow2 = document.createElement('div');
                improvementsRow2.className = 'flex justify-center gap-4 flex-wrap';
                for(let i=3; i < CARDS_PER_AXE; i++) improvementsRow2.appendChild(createCard('improvement', context.id, i));
                improvementsSection.appendChild(improvementsRow2);
                content.appendChild(improvementsSection);

                details.appendChild(summary);
                details.appendChild(content);
                allContextsContainer.appendChild(details);
                
                updateContextEntryCounter(context.id);

                // Accordion exclusivity logic
                details.addEventListener('toggle', (event) => {
                    if (details.open) {
                        allDetailsElements.forEach(otherDetails => {
                            if (otherDetails !== details && otherDetails.open) {
                                otherDetails.open = false;
                            }
                        });
                    }
                });
            });
            if(submitButton) submitButton.disabled = false; 
        }
        
        if(feedbackForm) {
            feedbackForm.addEventListener('submit', async (event) => {
                event.preventDefault(); 
                
                let formIsValid = true;
                let firstInvalidContextLabel = "";
                for (const context of contexts) {
                    const filledCount = countFilledCardsForContext(context.id);
                    if (filledCount > MAX_ENTRIES_PER_CONTEXT) {
                        formIsValid = false;
                        firstInvalidContextLabel = context.label;
                        const problemAccordion = document.getElementById(`entryCounter-${context.id}`);
                        if(problemAccordion) {
                            problemAccordion.scrollIntoView({behavior: "smooth", block: "center"});
                            const detailsElement = problemAccordion.closest('details');
                            if (detailsElement && !detailsElement.open) {
                                detailsElement.open = true;
                            }
                        }
                        break; 
                    }
                }

                if (!formIsValid) {
                    showModal("Validation √âchou√©e", `Pour le contexte "${firstInvalidContextLabel}", vous avez saisi plus de ${MAX_ENTRIES_PER_CONTEXT} descriptions. Veuillez corriger.`);
                    if(modalCloseButton) modalCloseButton.textContent = "Fermer";
                    return;
                }
                
                if(submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="spinner !w-6 !h-6 !border-2 inline-block mr-2"></div>Envoi en cours...';
                }

                const formData = new FormData(feedbackForm);
                const body = new URLSearchParams(formData).toString();

                try {
                    const response = await fetch("/", { 
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body,
                    });

                    if (response.ok) {
                        console.log("Feedback soumis avec succ√®s √† Netlify.");
                        
                        const successModalCloseAction = () => {
                            const newWindow = window.open('about:blank', '_self');
                            if (newWindow) { newWindow.close(); }
                            if (messageModal) messageModal.style.display = "none"; 
                        };
                        
                        if(modalCloseButton) modalCloseButton.textContent = "Fermer la page";
                        showModal("Merci infiniment !", "Votre feedback a √©t√© soumis avec succ√®s. Vos retours sont pr√©cieux pour nous aider √† nous am√©liorer. Vous pouvez maintenant fermer cette page.", successModalCloseAction);
                        
                        if(feedbackForm) feedbackForm.style.display = 'none';
                        if(mainHeaderDiv) mainHeaderDiv.style.display = 'none'; 

                    } else {
                        const errorText = await response.text();
                        console.error("Erreur de soumission √† Netlify:", response.status, errorText);
                        showModal("Erreur de Soumission", `Une erreur est survenue (status: ${response.status}). Veuillez r√©essayer ou nous contacter si le probl√®me persiste.`);
                        if(modalCloseButton) modalCloseButton.textContent = "Fermer"; 
                    }
                } catch (error) {
                    console.error("Erreur de r√©seau ou autre lors de la soumission √† Netlify:", error);
                    showModal("Erreur de Soumission", "Une erreur de r√©seau est survenue. Veuillez v√©rifier votre connexion et r√©essayer.");
                    if(modalCloseButton) modalCloseButton.textContent = "Fermer"; 
                } finally {
                     if(submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Envoyer le feedback';
                    }
                }
            });
        }

        function main() {
            if(feedbackForm) feedbackForm.style.display = 'block'; 
            if(mainHeaderDiv) mainHeaderDiv.style.display = 'block'; 
            
            renderAllContexts(); 
            
            if(loadingOverlay) loadingOverlay.style.display = 'none';
        }
        
        main(); 
        
    </script>
</body>
</html>
