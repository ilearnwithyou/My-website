<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Feedback Anonyme (Netlify)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .modal-close-button {
            background-color: #4f46e5; 
            color: white;
            padding: 10px 20px;
            border-radius: 0.375rem;
            cursor: pointer;
            margin-top: 15px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5; 
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .count-display {
            font-weight: 500;
        }
        .count-error {
            color: #ef4444; /* Tailwind red-500 */
        }
        .count-valid {
            color: #10b981; /* Tailwind green-500 */
        }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="spinner"></div>
        <p class="ml-3 text-gray-700">Chargement...</p>
    </div>

    <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8 bg-white shadow-xl rounded-lg mt-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">Feedback Anonyme et Bienveillant</h1>
            <p class="text-gray-600 mt-2">Vos retours sont précieux. Merci de faire preuve de franchise et de bienveillance.</p>
        </header>

        <div id="shareLinkSection" class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md" style="display: none;">
            <h2 class="font-semibold">Partagez ce lien pour recevoir du feedback :</h2>
            <p id="shareableLink" class="mt-1 break-all bg-blue-100 p-2 rounded"></p>
            <p class="mt-2 text-sm">Votre identifiant unique (pour référence) : <strong id="userUniqueIdDisplay"></strong></p>
        </div>
        
        <div id="invalidLinkSection" class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md" style="display: none;">
            <h2 class="font-semibold">Lien Invalide</h2>
            <p id="invalidLinkMessage">Ce formulaire ne peut pas être utilisé sans un identifiant de destinataire valide dans l'URL (paramètre `formFor`).</p>
        </div>

        <!-- Modification pour Netlify Forms: ajout de 'netlify' (ou data-netlify="true") et d'un nom au formulaire -->
        <form id="feedbackForm" name="feedback" netlify>
            <!-- Champ caché pour le nom du formulaire, requis par Netlify si le nom est dynamique ou pour AJAX -->
            <input type="hidden" name="form-name" value="feedback" />
            <!-- Champ caché pour stocker l'ID de la personne qui reçoit le feedback -->
            <input type="hidden" id="targetUserIdField" name="targetUserId" value="" />

            <div class="mb-6">
                <label for="context" class="block text-sm font-medium text-gray-800 mb-1">Pour quel contexte souhaitez-vous donner du feedback ?</label>
                <select id="context" name="context" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <option value="">-- Choisissez un contexte --</option>
                    <option value="travail">Travail / Entreprise</option>
                    <option value="formation">Formation</option>
                    <option value="cours">Cours</option>
                    <option value="vie_personnelle">Vie Personnelle</option>
                </select>
            </div>
            
            <p id="overallInstruction" class="text-sm text-gray-700 bg-indigo-50 p-3 rounded-md mb-2 border border-indigo-200" style="display: none;">
                Veuillez fournir un total de <strong>10 descriptions</strong> (atouts et/ou faiblesses combinés) parmi les champs ci-dessous.
            </p>
            <div id="entryCounter" class="text-sm text-gray-600 mb-6 p-3 rounded-md" style="display: none;">
                Descriptions saisies : <span id="filledCountDisplay" class="count-display">0</span> / 10
            </div>

            <div id="adjectivesContainer" class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Atouts <span id="strengthsCountDisplay" class="text-sm font-normal text-gray-500">(0 disponibles)</span></h3>
                    <p class="text-sm text-gray-500 mb-3">Décrivez en quelques mots clés les principales forces.</p>
                    <div id="strengthsInputsContainer" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Axes d'amélioration / Faiblesses <span id="weaknessesCountDisplay" class="text-sm font-normal text-gray-500">(0 disponibles)</span></h3>
                     <p class="text-sm text-gray-500 mb-3">Quels sont les points sur lesquels une amélioration serait bénéfique ? Soyez constructif.</p>
                    <div id="weaknessesInputsContainer" class="space-y-3"></div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button type="submit" id="submitButton" class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                    Soumettre le Feedback
                </button>
            </div>
        </form>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-semibold mb-3"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <button id="modalCloseButton" class="modal-close-button">Fermer</button>
        </div>
    </div>

    <script type="module">
        // Declare modal DOM elements constants *before* showModal function
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        
        function showModal(title, message) {
            if (modalTitle && modalMessage && messageModal) { 
                modalTitle.textContent = title;
                modalMessage.innerHTML = message; 
                messageModal.style.display = "block";
            } else {
                console.error("Modal elements not found. Cannot display message:", title, message);
                alert(title + "\n\n" + message.replace(/<br\s*\/?>/gi, "\n"));
            }
        }
        
        if (modalCloseButton) {
            modalCloseButton.onclick = () => { if(messageModal) messageModal.style.display = "none"; };
        }
        window.onclick = (event) => {
            if (event.target == messageModal && messageModal) {
                messageModal.style.display = "none";
            }
        }
        
        let targetUserId = null; 
        let generatedUserShareId = null; 

        const loadingOverlay = document.getElementById('loading-overlay');
        const shareLinkSection = document.getElementById('shareLinkSection');
        const shareableLinkEl = document.getElementById('shareableLink');
        const userUniqueIdDisplayEl = document.getElementById('userUniqueIdDisplay');
        const invalidLinkSection = document.getElementById('invalidLinkSection');
        // const invalidLinkMessageEl = document.getElementById('invalidLinkMessage'); // Plus utilisé directement
        const feedbackForm = document.getElementById('feedbackForm'); 
        const targetUserIdField = document.getElementById('targetUserIdField'); // Champ caché
        const contextSelect = document.getElementById('context');
        const overallInstruction = document.getElementById('overallInstruction');
        const entryCounterDiv = document.getElementById('entryCounter');
        const filledCountDisplay = document.getElementById('filledCountDisplay');
        const strengthsInputsContainer = document.getElementById('strengthsInputsContainer');
        const weaknessesInputsContainer = document.getElementById('weaknessesInputsContainer');
        const strengthsCountDisplayEl = document.getElementById('strengthsCountDisplay');
        const weaknessesCountDisplayEl = document.getElementById('weaknessesCountDisplay');
        const submitButton = document.getElementById('submitButton');

        const contextLabels = {
            travail: "Travail / Entreprise",
            formation: "Formation",
            cours: "Cours",
            vie_personnelle: "Vie Personnelle"
        };

        const NUM_INPUTS_PER_CATEGORY = 10; 
        const TOTAL_ADJECTIVES_REQUIRED = 10; 

        function generateUUID() { 
            return crypto.randomUUID();
        }
        
        function countFilledInputs() {
            if (!strengthsInputsContainer || !weaknessesInputsContainer) return 0;
            const filledStrengthsCount = Array.from(strengthsInputsContainer.querySelectorAll('input[name="strength"]'))
                                         .filter(input => input.value.trim() !== '').length;
            const filledWeaknessesCount = Array.from(weaknessesInputsContainer.querySelectorAll('input[name="weakness"]'))
                                          .filter(input => input.value.trim() !== '').length;
            return filledStrengthsCount + filledWeaknessesCount;
        }

        function updateEntryCounter() {
            if (!contextSelect || contextSelect.value === "") { 
                if(entryCounterDiv) entryCounterDiv.style.display = 'none';
                return;
            }
            if(entryCounterDiv) entryCounterDiv.style.display = 'block';
            const totalFilled = countFilledInputs();
            if(filledCountDisplay) filledCountDisplay.textContent = totalFilled;

            if (totalFilled > TOTAL_ADJECTIVES_REQUIRED) {
                if(filledCountDisplay) {
                    filledCountDisplay.classList.add('count-error');
                    filledCountDisplay.classList.remove('count-valid');
                }
                if(entryCounterDiv) {
                    entryCounterDiv.classList.add('bg-red-50', 'border', 'border-red-200');
                    entryCounterDiv.classList.remove('bg-green-50', 'border-green-200', 'bg-indigo-50', 'border-indigo-200');
                }
            } else if (totalFilled === TOTAL_ADJECTIVES_REQUIRED) {
                 if(filledCountDisplay) {
                    filledCountDisplay.classList.add('count-valid');
                    filledCountDisplay.classList.remove('count-error');
                }
                if(entryCounterDiv) {
                    entryCounterDiv.classList.add('bg-green-50', 'border', 'border-green-200');
                    entryCounterDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-indigo-50', 'border-indigo-200');
                }
            } else {
                if(filledCountDisplay) {
                    filledCountDisplay.classList.remove('count-error', 'count-valid');
                }
                if(entryCounterDiv) {
                    entryCounterDiv.classList.add('bg-indigo-50', 'border', 'border-indigo-200');
                    entryCounterDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200');
                }
            }
        }

        function updateAdjectiveInputs(selectedContextValue) {
            if(strengthsInputsContainer) strengthsInputsContainer.innerHTML = '';
            if(weaknessesInputsContainer) weaknessesInputsContainer.innerHTML = '';
            updateEntryCounter(); 

            if (!selectedContextValue) {
                if(strengthsCountDisplayEl) strengthsCountDisplayEl.textContent = `(0 disponibles)`;
                if(weaknessesCountDisplayEl) weaknessesCountDisplayEl.textContent = `(0 disponibles)`;
                if(overallInstruction) overallInstruction.style.display = 'none';
                if(entryCounterDiv) entryCounterDiv.style.display = 'none';
                if(submitButton) submitButton.disabled = true;
                return;
            }

            if(overallInstruction) overallInstruction.style.display = 'block';
            if(entryCounterDiv) entryCounterDiv.style.display = 'block';
            if(strengthsCountDisplayEl) strengthsCountDisplayEl.textContent = `(${NUM_INPUTS_PER_CATEGORY} disponibles)`;
            if(weaknessesCountDisplayEl) weaknessesCountDisplayEl.textContent = `(${NUM_INPUTS_PER_CATEGORY} disponibles)`;

            for (let i = 0; i < NUM_INPUTS_PER_CATEGORY; i++) {
                const strengthInput = document.createElement('input');
                strengthInput.type = 'text';
                strengthInput.name = 'strength'; // Important pour Netlify Forms pour grouper les champs
                strengthInput.placeholder = `Atout #${i + 1}`;
                strengthInput.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';
                strengthInput.addEventListener('input', updateEntryCounter);
                if(strengthsInputsContainer) strengthsInputsContainer.appendChild(strengthInput);

                const weaknessInput = document.createElement('input');
                weaknessInput.type = 'text';
                weaknessInput.name = 'weakness'; // Important pour Netlify Forms pour grouper les champs
                weaknessInput.placeholder = `Point d'amélioration #${i + 1}`;
                weaknessInput.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';
                weaknessInput.addEventListener('input', updateEntryCounter);
                if(weaknessesInputsContainer) weaknessesInputsContainer.appendChild(weaknessInput);
            }
            if(submitButton) submitButton.disabled = false;
            updateEntryCounter(); 
        }

        if(contextSelect) {
            contextSelect.addEventListener('change', (event) => {
                updateAdjectiveInputs(event.target.value);
            });
        }
        
        if(feedbackForm) {
            feedbackForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Empêche la soumission HTML classique au début

                const totalFilledCount = countFilledInputs();
                if (totalFilledCount !== TOTAL_ADJECTIVES_REQUIRED) {
                     showModal("Validation Échouée", `Veuillez fournir un total exact de ${TOTAL_ADJECTIVES_REQUIRED} descriptions (atouts et/ou faiblesses). Vous en avez actuellement fourni ${totalFilledCount}.`);
                    return; // Empêche la soumission si la validation échoue
                }
                
                // Si la validation JS passe, on prépare la soumission pour Netlify
                if(submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="spinner !w-5 !h-5 !border-2 !m-0 inline-block mr-2"></div>Envoi en cours...';
                }

                // Création d'un objet FormData à partir du formulaire
                const formData = new FormData(feedbackForm);
                
                // Pour Netlify AJAX submission, il faut encoder les données
                const body = new URLSearchParams(formData).toString();

                try {
                    // Soumission à Netlify via fetch. L'action du formulaire est la page actuelle par défaut.
                    // Netlify attend un POST avec `application/x-www-form-urlencoded`
                    const response = await fetch("/", { // Ou l'action spécifiée dans votre form si différente
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body,
                    });

                    if (response.ok) {
                        console.log("Feedback soumis avec succès à Netlify.");
                        showModal("Merci !", "Votre feedback a été soumis avec succès !");
                        if(feedbackForm) feedbackForm.reset(); 
                        updateAdjectiveInputs(""); 
                        if(contextSelect) contextSelect.value = ""; 
                        if(overallInstruction) overallInstruction.style.display = 'none';
                        if(entryCounterDiv) entryCounterDiv.style.display = 'none'; 
                    } else {
                        // Gérer les erreurs de réponse de Netlify
                        const errorText = await response.text();
                        console.error("Erreur de soumission à Netlify:", response.status, errorText);
                        showModal("Erreur de Soumission", `Une erreur est survenue lors de la soumission du formulaire à Netlify (status: ${response.status}). Veuillez réessayer.`);
                    }
                } catch (error) {
                    console.error("Erreur de réseau ou autre lors de la soumission à Netlify:", error);
                    showModal("Erreur de Soumission", "Une erreur de réseau est survenue. Veuillez vérifier votre connexion et réessayer.");
                } finally {
                     if(submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Soumettre le Feedback';
                    }
                }
            });
        }

        function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const formForIdFromUrl = urlParams.get('formFor'); 

            if (formForIdFromUrl) { 
                targetUserId = formForIdFromUrl;
                if(targetUserIdField) targetUserIdField.value = targetUserId; // Remplir le champ caché
                console.log(`Formulaire pour donner du feedback à l'utilisateur : ${targetUserId}`);
                if(shareLinkSection) shareLinkSection.style.display = 'none';
                if(invalidLinkSection) invalidLinkSection.style.display = 'none';
                if(feedbackForm) feedbackForm.style.display = 'block';
            } else { 
                generatedUserShareId = generateUUID(); 
                targetUserId = generatedUserShareId; 
                if(targetUserIdField) targetUserIdField.value = targetUserId; // Remplir le champ caché
                
                console.log(`L'utilisateur veut obtenir son lien partageable. Son ID généré est : ${generatedUserShareId}.`);
                const shareUrl = `${window.location.origin}${window.location.pathname}?formFor=${generatedUserShareId}`;
                if(shareableLinkEl) shareableLinkEl.textContent = shareUrl;
                if(userUniqueIdDisplayEl) userUniqueIdDisplayEl.textContent = generatedUserShareId;
                if(shareLinkSection) shareLinkSection.style.display = 'block';
                if(invalidLinkSection) invalidLinkSection.style.display = 'none'; 
                if(feedbackForm) feedbackForm.style.display = 'block'; 
                
                const parentOfFeedbackForm = feedbackForm ? feedbackForm.parentNode : null;
                if (parentOfFeedbackForm) {
                    const existingTestMessage = parentOfFeedbackForm.querySelector('.test-message-feedback');
                    if (!existingTestMessage) {
                        const testMessage = document.createElement('p');
                        testMessage.className = 'text-sm text-gray-600 bg-yellow-50 p-3 rounded-md mb-4 border border-yellow-300 test-message-feedback';
                        testMessage.innerHTML = `Utilisez le formulaire ci-dessous pour tester la soumission de feedback pour vous-même. Les réponses iront à votre propre identifiant généré (<strong>${generatedUserShareId}</strong>). Partagez le lien ci-dessus avec vos collègues.`;
                        parentOfFeedbackForm.insertBefore(testMessage, feedbackForm);
                    }
                }
            }
            updateAdjectiveInputs(contextSelect ? contextSelect.value : ""); 
            if(loadingOverlay) loadingOverlay.style.display = 'none';
        }
        
        main(); // Exécuter main directement
        
    </script>
</body>
</html>
